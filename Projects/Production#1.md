
apiVersion: v1
kind: Pod
metadata:
  name: my-pod
spec:
  containers:
  - name: my-container
    image: my-image
    volumeMounts:
    - name: volume-mount
      mountPath: /asset
  volumes:
  - name: volume-mount
    hostPath:
      path: /volume


운영하다가 갑자기 썸네일 이미지 다 날아가는 상황 발생
마스터노드에 접근해 kubectl get pods -o wide로 확인해보니
백엔드파드가 UnknwonState, Evoked, Running 세개로 늘어나있었음

kubectl logs pods ~ 
로 확인해보니 이미 종료된 pod라 로그가 남아있지 않음. 따로 메트릭을 수집하는 프로메테우스나 그라파나같은 툴을 사용하지 않고있었기 때문에
kubectl describe pods ~로 확인
원인 : 노드의 disk-pressure

이미지는 백엔드 컨테이너 내부에서 저장하고 관리하고 있었기 때문에, 노드에 문제가 생겨 파드를 재시작하는 과정에서 컨테이너가 초기화되어 이미지가 다 날라간 것

사실 이런 문제가 있을 거라고 생각해서 며칠 샘플 게시물들을 올려보면서 트래픽을 받고 문제가 없나 확인중이었는데, 일찍 발견하게 되서 다행이었음

디스크프레셔라면 인스턴스 생성시 디폴트로 스토리지 설정에서 ssd 8GiB로 설정되어 생성한 게 문제가 되었나봄
그래서 terrform으로 ec2스토리지 (EBS)연결 코드를 추가하고
마스터노드 8, 데이터베이스노드 8, 백엔드/프런트엔드 노드 16으로 늘려줬음
프리티어는 EBS 최대 30GiB까지 무료라 최대한 맞췄음

## 스토리지 테라폼

사실 스토리지를 설정하지 않아도 인스턴스 생성 가능.
디폴트로 8GIB의 gp2(SSD) EBS 볼륨이 자동으로 생성되고 연결됨
AWS의 인스턴스는 조금 신기하게, 인스턴스 내부에 볼륨이 있는 게 아니라. 인스턴스 AMI따로 볼륨(EBS)따로 있어서
하나의 인스턴스에 여러개 EBS볼륨을 연결할 수도 있고 연결해제할 수도 있고 함
EBS볼륨 1, 2가 있을 때 둘 다 하나 인스턴스에 연결해서 1에는 text1.txt을 넣고, 2에는 text2.txt를 넣고
2를 연결 해제하면 인스턴스에 접속했을 때 text1.txt만 확인할 수 있음. 이런 식임

이렇게 추가적으로 EBS를 생성하고 attachment를 실행하는 건 조금 더 복잡하고, 디폴트 EBS 하나를 연결하는 건 instance 리소스 내부에서 해결가능

---

이제 오류가 생긴 원인인 스토리지는 해결했고, 이미지가 사라지게 된 원인을 해결해야함
이걸 해결하지 못하면 다른 오류가 생겼을 때 또 이미지가 다 날라가게 될 것임

볼륨을 백엔드 디플로이먼트 yaml파일에도 설정해줬음

(루트 볼륨 코드)

근데 오류가 생김. 왜?
볼륨은 루트 경로에 불가. 보안이유

볼륨은 마운트한다고 폴더가 생성되는 것이 아님
볼륨마운트의 mountpath는 루트경로도 안되지만, 실제 컨테이너 내부에 존재하는 경로여야함

db볼륨과 be볼륨 똑같이 deployment yaml파일에서 설정했는데
db는 deployment/pod 지웠다 다시 시작해도 볼륨으로 유지되고, db올라가있는 노드에 접속해도 볼륨이 확인되는데,
be는 노드에 볼륨은 생성됐는데, be에서 추가된 파일이 볼륨에 저장되지 않음
문제는 컨테이너 이미지(도커파일)의 workdir이었음. db는 workdir을 따로 설정하지 않았는데, be는 /app으로 설정해둬서 볼륨이 컨테이너 app/assets이 아니라 /assets과 연결되고 있었던 것!
그래서 backend-deployment.yaml 파일에서 volumeMounts: mountPath: app/assets으로 설정하니 노드 볼륨과 잘 연결되는 걸 확인할 수 있었음.

---

## 정리 및 추가

이렇게 하니 서비스 업데이트 이후 파드나 deployment를 삭제 후 재생성해도 게시글과 게시글 이미지가 그대로 잘 보존되는 걸 확인할 수 있었음

근데 문제가 완벽히 해결되진 않았음. 노드에 볼륨을 생성하고, 이 볼륨을 컨테이너에 마운트해서 컨테이너가 사라져도 그 전까지 컨테이너가 볼륨에 올린 데이터는 노드의 볼륨에 남아있을 수 있는데, 만약 노드가 삭제된다면? 그럼 내 블로그 이미지들은 또 사라지게 된다.

해결하려면 외부 스토리지를 사용할 수 있다. AWS 서비스인 S3 버킷을 이용하는 방법이 일반적인 것 같다. 아직은 지금 배포과정에서 공부할 게 많기에 다음에 공부하고 적용해보기로 하고, 이런 방법이 또 있다는 걸 소개하고 싶었다.